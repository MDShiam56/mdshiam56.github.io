<!DOCTYPE html>
<html lang="en">
<head>
    <script>(function(s){s.dataset.zone='10519183',s.src='https://nap5k.com/tag.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    <script>(function(s){s.dataset.zone='10519181',s.src='https://gizokraijaw.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    <script src="https://quge5.com/88/tag.min.js" data-zone="205534" async data-cfasync="false"></script>
    <script>(function(s){s.dataset.zone='10519178',s.src='https://al5sm.com/tag.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw - N S T CLUB PRO</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap');
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: radial-gradient(circle at top, #1a2e24, #0b1a13); 
            margin: 0; padding: 15px; color: white; 
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card { 
            background: rgba(26, 46, 36, 0.85); 
            backdrop-filter: blur(15px);
            padding: 30px; border-radius: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
            max-width: 420px; width: 100%;
            border: 1px solid rgba(29, 204, 112, 0.3);
            animation: slideUp 0.6s ease-out;
            margin-top: 20px;
        }

        h2 { color: #1dcc70; text-align: center; margin-bottom: 25px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        
        .balance-view { 
            background: linear-gradient(135deg, rgba(29, 204, 112, 0.1), rgba(29, 204, 112, 0.05)); 
            padding: 20px; border-radius: 15px; text-align: center; 
            margin-bottom: 25px; border: 1px solid rgba(29, 204, 112, 0.4); 
        }
        
        label { display: block; margin-bottom: 8px; color: #1dcc70; font-size: 13px; font-weight: 500; }
        
        select, input { 
            width: 100%; padding: 14px; margin-bottom: 20px; 
            border: 1px solid #333; background: rgba(0,0,0,0.4); 
            color: white; border-radius: 10px; box-sizing: border-box; 
            font-size: 16px; outline: none; transition: 0.3s;
        }
        
        select:focus, input:focus { border-color: #1dcc70; box-shadow: 0 0 10px rgba(29, 204, 112, 0.3); }

        .btn-withdraw { 
            width: 100%; background: linear-gradient(135deg, #1dcc70, #16a35a); 
            color: white; border: none; padding: 16px; border-radius: 10px; 
            font-weight: bold; font-size: 17px; cursor: pointer; 
            transition: 0.3s; box-shadow: 0 5px 15px rgba(29, 204, 112, 0.3);
        }
        
        .btn-withdraw:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(29, 204, 112, 0.5); }
        .back-btn { text-decoration: none; color: #1dcc70; font-size: 14px; margin-bottom: 10px; display: block; align-self: flex-start; }
    </style>
</head>
<body>

    <div style="max-width: 420px; width: 100%;">
        <a href="index.html" class="back-btn">← Back to Dashboard</a>

        <div class="card">
            <h2>Withdraw</h2>
            
            <div class="balance-view">
                <p style="margin:0; color:#aaa; font-size: 14px;">Total Withdrawable Balance</p>
                <h3 style="margin:5px 0; color:#1dcc70; font-size: 28px;">৳ <span id="current-bal">0.00</span></h3>
            </div>

            <label>Payment Method</label>
            <select id="wit-method">
                <option value="Bkash">Bkash (Personal)</option>
                <option value="Nagad">Nagad (Personal)</option>
                <option value="Rocket">Rocket (Personal)</option>
            </select>

            <label>Account Number</label>
            <input type="number" id="wit-num" placeholder="01XXXXXXXXX">

            <label>Amount (Min 500৳)</label>
            <input type="number" id="wit-amount" placeholder="Min 500">

            <button id="submit-btn" class="btn-withdraw">Confirm Withdrawal</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getDatabase, ref, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD-U5wOhyMDsiFf7NB4-twMFNnoWCXVXpE",
            authDomain: "login-52331.firebaseapp.com",
            projectId: "login-52331",
            storageBucket: "login-52331.firebasestorage.app",
            messagingSenderId: "199346485569",
            appId: "1:199346485569:web:69014a90e2031e147609c0",
            databaseURL: "https://login-52331-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let userBalance = 0;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                onValue(ref(db, 'users/' + user.uid), (snap) => {
                    const userData = snap.val();
                    if (userData) {
                        userBalance = parseFloat(userData.balance) || 0;
                        document.getElementById('current-bal').innerText = userBalance.toLocaleString();
                    }
                });
            } else {
                window.location.href = "login.html";
            }
        });

        async function submitWithdraw() {
            const method = document.getElementById('wit-method').value;
            const number = document.getElementById('wit-num').value;
            const amount = parseFloat(document.getElementById('wit-amount').value);
            const user = auth.currentUser;

            if (!user) return;
            if (number.length < 11) { alert("সঠিক নম্বর দিন।"); return; }
            if (isNaN(amount) || amount < 500) { alert("সর্বনিম্ন ৫০০৳ উইথড্র করুন।"); return; }
            if (amount > userBalance) { alert("পর্যাপ্ত ব্যালেন্স নেই!"); return; }

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerText = "Processing...";

            try {
                // Deduct balance first to prevent double-spending
                const newBalance = userBalance - amount;
                await update(ref(db, 'users/' + user.uid), { balance: newBalance });

                const withdrawRef = ref(db, 'withdrawRequests');
                const newReqRef = push(withdrawRef);
                await set(newReqRef, {
                    uid: user.uid,
                    email: user.email,
                    method: method,
                    accountNumber: number,
                    amount: amount,
                    status: 'Pending',
                    timestamp: new Date().toLocaleString()
                });

                alert("উইথড্র রিকোয়েস্ট সফল হয়েছে!");
                window.location.href = "index.html";

            } catch (error) {
                alert("Error: " + error.message);
                btn.disabled = false;
                btn.innerText = "Confirm Withdrawal";
            }
        }
        document.getElementById('submit-btn').onclick = submitWithdraw;
    </script>
</body>
</html>
